<?php

/**
 * Let op: oauth2_server heeft geen API om automatisch servers of clients toe te voegen.
 * Dat betekent dat via Structuur -> OAuth2 Servers een server moet worden aangemaakt met de volgende instellingen:
 * - Naam: Main. 'Require exact redirect uri' uitvinken.
 * - Scope toevoegen met systeemnaam 'sp'.
 * - Clients toevoegen voor iedere site. Vul de exacte redirect-uri in (voor Drupal-sites: https://<sitenaam>/oauth/authorized2/1) en vink het hokje 'Automatically authorize this client' aan.
 * De onderstaande hooks zorgen voor het beschikbaar maken van een API om informatie over de ingelogde gebruiker en zijn groepen op te vragen.
 */

/**
 * Implementation of hook_default_services_endpoint().
 * Maakt een OAuth2-geauthenticeerde API beschikbaar onder /oauth2/api
 * @return array Endpoints
 */
function oauthloginprovider_default_services_endpoint() {
	$endpoint = new stdClass();
	$endpoint->disabled = false;
	$endpoint->api_version = 3;
	$endpoint->name = 'oauth2login';
	$endpoint->server = 'rest_server';
	$endpoint->path = 'oauth2/api';
	$endpoint->authentication = array(
		'oauth2_server' => array(
			'server' => 'main',
		),
	);
	$endpoint->server_settings = array(
		'formatters' => array(
			'bencode' => false,
			'json'    => true,
			'php'     => false,
			'xml'     => true,
			'jsonp'   => false,
		),
		'parsers'    => array(
			'application/json'                  => true,
			'application/vnd.php.serialized'    => true,
			'application/x-www-form-urlencoded' => false,
			'application/xml'                   => true,
			'multipart/form-data'               => true,
			'text/xml'                          => true,
			'text/yaml'                         => false,
		),
	);
	$endpoint->resources = array(
		'me' => array(
			'operations' => array(
				'index' => array(
					'enabled'  => '1',
					'settings' => array(
						'oauth2_server' => array(
							'require_authentication' => '1',
							'scope'                  => 'sp',
						),
					),
				),
			),
		),
		'roles' => array(
			'operations' => array(
				'index' => array(
					'enabled'  => '1',
					'settings' => array(
						'oauth2_server' => array(
							'require_authentication' => '0',
							'scope'                  => 'sp',
						),
					),
				),
			),
		),
		'civiapi' => array(
			'operations' => array(
				'index' => array(
					'enabled'  => '1',
					'settings' => array(
						'oauth2_server' => array(
							'require_authentication' => '1',
							'scope'                  => 'civicrm',
						),
					),
				),
			),
		),
	);
	$endpoint->debug = 1;

	$endpoints[$endpoint->name] = $endpoint;
	return $endpoints;
}


/**
 * Implementation of hook_services_resources().
 * API-method om informatie over een gebruiker op te halen vanaf een client-site.
 * @return array Resources
 */
function spoauthprovider_services_resources() {
	$res = array(
		'me' => array(
			'operations' => array(
				'index' => array(
					'access callback'         => 'user_access',
					'access arguments'        => array('use oauth2 server'),
					'help'                    => 'Retrieves information about the current user',
					'callback'                => 'spoauthprovider_me_index_action',
				),
			),
		),
		'roles' => array(
			'operations' => array(
				'index' => array(
					'access callback'         => 'user_access',
					'access arguments'	  	  => array('use oauth2 server'),
					'help'                    => 'Lists roles that are available on this Drupal installation',
					'callback'                => 'spoauthprovider_roles_index_action',
				),
			),
		),
		'civiapi' => array(
			'operations' => array(
				'index' => array(
					'access callback'         => 'spoauthprovider_civiapi_access',
					'help'                    => 'Calls the CiviCRM API as the current user',
					'callback'                => 'spoauthprovider_civiapi_index_action',
				),
			),
		),
	);
	return $res;
}

/**
 * API-actie onder /oauth2/api/me. Retourneert een object met de ingelogde user,
 * en een uitgebreid overzicht (met id's en namen) van (Drupal-)rollen.
 * @return object
 */
function spoauthprovider_me_index_action() {

	// Load entire user object (anders zijn extra velden niet beschikbaar)
	global $user;
	$myuser = user_load($user->uid, true);

	$data = (array)$myuser;
	$unset = array('pass', 'session', 'cache', 'sid', 'ssid', 'uuid', 'data', 'rdf_mapping');
	foreach($unset as $u) {
		if(array_key_exists($u, $data))
			unset($data[$u]);
	}

	foreach($data['roles'] as $key => &$value) {
		$data['roles'][$key] = array(
			'id' => $key,
			'name' => $value,
		);
	}

	foreach($data as $key => &$value) {
		if(is_array($value) && array_key_exists(LANGUAGE_NONE, $value))
			$value = $value[LANGUAGE_NONE][0]['value'];
	}

	return (object)$data;
}

/**
 * API-actie onder /oauth2/api/roles. Retourneert alle rollen die bestaan op deze installatie.
 * @return object
 */
function spoauthprovider_roles_index_action() {

	$data = array();

	foreach(user_roles(true) as $key => $name) {
		$data['roles'][$key] = array(
			'id' => $key,
			'name' => $name,
		);
	}

	return (object)$data;
}

/**
 * API-actie onder /oauth2/api/civiapi. Roept de CiviCRM-API aan met de rechten van de huidige gebruiker.
 * Required parameters:
 * - key, de CiviCRM site key (gewoon als extra check)
 * - alle toepasselijke CiviCRM API parameters: entity, action, debug, sequential, id, enz enz enz
 * @return object
 */
function spoauthprovider_civiapi_index_action() {

	if(!civicrm_initialize()) {
		return (object)['is_error' => 1, 'error_message' => 'Could not initialize CiviCRM.'];
	}

	if (empty($_REQUEST['key']) || !CRM_Utils_System::authenticateKey(FALSE)) {
			return (object)['is_error' => 1, 'error_message' => 'Invalid CiviCRM site key.'];
	}

	$entity = $_REQUEST['entity'];
	$action = $_REQUEST['action'];
	if(!$entity || !$action) {
		return (object)['is_error' => 1, 'error_message' => 'Required parameters "entity" and "action" missing.'];
	}
	if(stripos($action, 'get') !== 0) {
		return (object)['is_error' => 1, 'error_message' => 'Only GET calls are currently allowed via this API.'];
	}

	// We gebruiken van de CiviCRM REST-klasse alleen de process-functie.
	// Niet handle() of run() want die gaan authenticeren obv de API key.

	$args = ['civicrm', $entity, $action];
	$result = CRM_Utils_REST::process($args, CRM_Utils_REST::buildParamList());

	return (object)$result;
}

/**
 * Access callback voor /civiapi resource.
 * @return bool Has access
 */
function spoauthprovider_civiapi_access() {
	return (user_access('use oauth2 server') && user_access('access CiviCRM'));
}